jobs:
  include:
    - stage: test
      language: node_js
      if: (type = push) or (type = pull_request and branch = master)
      node_js:
        - '12'
      install:
        - npm i
      script:
        - npm run test
      cache:
        directories:
          - 'node_modules'
      notifications:
        email: false
    - stage: build
      language: node_js
      if: (type = pull_request and branch = master)
      node_js:
        - '12'
      install:
        - npm i
      script:
        - npm run build
      cache:
        directories:
          - 'node_modules'
      notifications:
        email: false

    - stage: deploy
      # only release on master branch with specific commit message (generated by npm version)
      if: (branch = master) AND (tag =~ /^[0-9]*\.[0-9]*\.[0-9]*$/) AND (NOT (type IN (push, pull_request)))
      language: node_js
      node_js:
        - '12'
      install:
        - npm i
      script:
        - npm run test
        - npm run build
      cache:
        directories:
          - 'node_modules'
      notifications:
        email: false
      deploy:
        - provider: npm
          email: 'r.heinen@nanogiants.de'
          api_key: $NPM_TOKEN
          skip_cleanup: true
